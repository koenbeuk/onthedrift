<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>EFCore.Projectables and the curious case of an unexpected performance boost - On The Drift</title><meta name=description content="Last time, I wrote about a new library called EntityFrameworkCore.Projectables. In short this library allows us to query over properties and methods completely written in CSharp. While I was implementing benchmarks to test the overhead of this Library, I was surprised to find out that the performance was actually improved when using Projectables over not using Projectables. Surely I must have made a mistake somewhere right? Well, lets dive in and see if we can find that out!"><meta name=author content="Koen"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"On The Drift","url":"https:\/\/www.onthedrift.com"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/www.onthedrift.com"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/www.onthedrift.com","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/www.onthedrift.com\/posts\/efcore-projectables-perf\/","name":"Efcore. projectables and the curious case of an unexpected performance boost"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Koen"},"headline":"EFCore.Projectables and the curious case of an unexpected performance boost","description":"Last time, I wrote about a new library called EntityFrameworkCore.Projectables. In short this library allows us to query over properties and methods completely written in CSharp. While I was implementing benchmarks to test the overhead of this Library, I was surprised to find out that the performance was actually improved when using Projectables over not using Projectables. Surely I must have made a mistake somewhere right? Well, lets dive in and see if we can find that out!","inLanguage":"en","wordCount":1394,"datePublished":"2021-07-15T00:00:00","dateModified":"2021-07-15T00:00:00","image":"https:\/\/www.onthedrift.com\/img\/avatar-squared-nobody.png","keywords":[".NET, EFCore, EFCore.Projectables"],"mainEntityOfPage":"https:\/\/www.onthedrift.com\/posts\/efcore-projectables-perf\/","publisher":{"@type":"Organization","name":"https:\/\/www.onthedrift.com","logo":{"@type":"ImageObject","url":"https:\/\/www.onthedrift.com\/img\/avatar-squared-nobody.png","height":60,"width":60}}}</script><meta property="og:title" content="EFCore.Projectables and the curious case of an unexpected performance boost"><meta property="og:description" content="Last time, I wrote about a new library called EntityFrameworkCore.Projectables. In short this library allows us to query over properties and methods completely written in CSharp. While I was implementing benchmarks to test the overhead of this Library, I was surprised to find out that the performance was actually improved when using Projectables over not using Projectables. Surely I must have made a mistake somewhere right? Well, lets dive in and see if we can find that out!"><meta property="og:image" content="https://www.onthedrift.com/img/avatar-squared-nobody.png"><meta property="og:url" content="https://www.onthedrift.com/posts/efcore-projectables-perf/"><meta property="og:type" content="website"><meta property="og:site_name" content="On The Drift"><meta name=twitter:title content="EFCore.Projectables and the curious case of an unexpected performance …"><meta name=twitter:description content="Last time, I wrote about a new library called EntityFrameworkCore.Projectables. In short this library allows us to query over properties and methods completely written in CSharp. While I was …"><meta name=twitter:image content="https://www.onthedrift.com/img/avatar-squared-nobody.png"><meta name=twitter:card content="summary"><meta name=twitter:site content="@onthedrift2"><meta name=twitter:creator content="@onthedrift2"><link href=https://www.onthedrift.com/img/avatar-squared-nobody.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.85.0"><link rel=alternate href=https://www.onthedrift.com/index.xml type=application/rss+xml title="On The Drift"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://www.onthedrift.com/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://www.onthedrift.com/css/highlight.min.css><link rel=stylesheet href=https://www.onthedrift.com/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://www.onthedrift.com>On The Drift</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Blog href=/>Blog</a></li><li><a title=Tags href=/tags>Tags</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="On The Drift" href=https://www.onthedrift.com><img class=avatar-img src=https://www.onthedrift.com/img/avatar-squared-nobody.png alt="On The Drift"></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=posts-heading><h1>EFCore.Projectables and the curious case of an unexpected performance boost</h1><hr class=small></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p>Last time, I wrote about a new library called <a href=https://github.com/koenbeuk/EntityFrameworkCore.Projectables>EntityFrameworkCore.Projectables</a>. In short this library allows us to query over properties and methods completely written in CSharp. While I was implementing benchmarks to test the overhead of this Library, I was surprised to find out that the performance was actually <strong>improved</strong> when using Projectables over not using Projectables. Surely I must have made a mistake somewhere right? Well, lets dive in and see if we can find that out!</p><h3 id=our-scenario>Our scenario</h3><p>First, let us create a sample scenario:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=k>public</span> <span class=k>class</span> <span class=nc>User</span> <span class=p>{</span>
    <span class=k>public</span> <span class=kt>int</span> <span class=n>Id</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>FirstName</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>LastName</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>And now, lets create a query that does something simple, namely selecting the concatenated forms of FirstName and LastName for all users, lets implement our default (non Projectable) benchmark first:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=na>[Benchmark(Baseline = true)]</span>
<span class=k>public</span> <span class=k>void</span> <span class=n>WithoutProjectables</span><span class=p>()</span> <span class=p>{</span>
    <span class=kt>var</span> <span class=n>query</span> <span class=p>=</span> <span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span>
        <span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>FirstName</span> <span class=p>+</span> <span class=s>&#34; &#34;</span> <span class=p>+</span> <span class=n>x</span><span class=p>.</span><span class=n>LastName</span><span class=p>);</span>

    <span class=n>query</span><span class=p>.</span><span class=n>ToQueryString</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div><p>Ok, that was easy. What about our Projectable benchmark? We could add a FullName property on our User class or simply use an extension method, lets go for the latter approach as this keeps the User class clean.</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=k>public</span> <span class=k>static</span> <span class=k>class</span> <span class=nc>UserExtensions</span> <span class=p>{</span>
<span class=na>    [Projectable]</span>
    <span class=k>public</span> <span class=k>static</span> <span class=kt>string</span> <span class=n>FullName</span><span class=p>(</span><span class=k>this</span> <span class=n>User</span> <span class=n>user</span><span class=p>)</span>
        <span class=p>=&gt;</span> <span class=n>user</span><span class=p>.</span><span class=n>FirstName</span> <span class=p>+</span> <span class=s>&#34; &#34;</span> <span class=p>+</span> <span class=n>user</span><span class=p>.</span><span class=n>LastName</span><span class=p>;</span>
<span class=p>}</span>
<span class=na>
</span><span class=na>[Benchmark]</span>
<span class=k>public</span> <span class=k>void</span> <span class=n>WithProjectables</span><span class=p>()</span> <span class=p>{</span>
    <span class=kt>var</span> <span class=n>query</span> <span class=p>=</span> <span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span>
        <span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>FullName</span><span class=p>());</span>

    <span class=n>query</span><span class=p>.</span><span class=n>ToQueryString</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div><p>Both queries result in the same generated QueryString namely (using the SQL Server database provider this time),</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=p>(</span><span class=n>COALESCE</span><span class=p>([</span><span class=n>u</span><span class=p>].[</span><span class=n>FirstName</span><span class=p>],</span><span class=w> </span><span class=n>N</span><span class=s1>&#39;&#39;</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>N</span><span class=s1>&#39; &#39;</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>COALESCE</span><span class=p>([</span><span class=n>u</span><span class=p>].[</span><span class=n>LastName</span><span class=p>],</span><span class=w> </span><span class=n>N</span><span class=s1>&#39;&#39;</span><span class=p>)</span><span class=w>
</span><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=p>[</span><span class=n>Users</span><span class=p>]</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>[</span><span class=n>u</span><span class=p>]</span><span class=w>
</span></code></pre></div><p>Given that the generated SQL is the same for both queries as they essentially do the same thing, What we would also expect performance to be equal. Perhaps our <code>WithoutProjectables</code> implementation would be slightly faster as it seems to have less to do, lets run these benchmarks and see the results:</p><table><thead><tr><th>Method</th><th style=text-align:right>Mean</th><th style=text-align:right>Error</th><th style=text-align:right>StdDev</th><th style=text-align:right>Ratio</th></tr></thead><tbody><tr><td>WithoutProjectables</td><td style=text-align:right>9.885 ms</td><td style=text-align:right>0.1890 ms</td><td style=text-align:right>0.1941 ms</td><td style=text-align:right>1.00</td></tr><tr><td>WithProjectables</td><td style=text-align:right>6.030 ms</td><td style=text-align:right>0.0282 ms</td><td style=text-align:right>0.0236 ms</td><td style=text-align:right>0.61</td></tr></tbody></table><p>This is unexpected. The <code>WithProjectables</code> benchmark almost shows a 40% performance improvement over the <code>WithoutProjectables</code> benchmark while seemingly doing more. Lets dive in and see if we can figure out what is going on here.</p><h3 id=diving-in>Diving in</h3><p>Let&rsquo;s see what happens under the hood. First any method or property that is marked with the [Projectable] attribute receives a generated companion expression tree that can be used by EF Core at runtime to swap out the Property/Method call for the actual expression tree. Lets see what this looks like:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=k>public</span> <span class=k>static</span> <span class=n>System</span><span class=p>.</span><span class=n>Linq</span><span class=p>.</span><span class=n>Expressions</span><span class=p>.</span><span class=n>Expression</span><span class=p>&lt;</span><span class=n>System</span><span class=p>.</span><span class=n>Func</span><span class=p>&lt;</span><span class=n>User</span><span class=p>,</span> <span class=kt>string</span><span class=p>&gt;&gt;</span> <span class=n>Expression</span> <span class=p>=&gt;</span> 
    <span class=p>(</span><span class=n>User</span> <span class=n>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=n>user</span><span class=p>.</span><span class=n>FirstName</span> <span class=p>+</span> <span class=s>&#34; &#34;</span> <span class=p>+</span> <span class=n>user</span><span class=p>.</span><span class=n>LastName</span><span class=p>;</span>
</code></pre></div><p>This generated Expression Tree is exactly as we we&rsquo;re expecting. Following the runtime logic, we can now simulate what is going on behind the scenes, namely A call like this:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span><span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>FullName</span><span class=p>());</span>
</code></pre></div><p>Will get translated by the runtime into a call like this:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span><span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>user</span> <span class=p>=&gt;</span> <span class=n>user</span><span class=p>.</span><span class=n>FirstName</span> <span class=p>+</span> <span class=s>&#34; &#34;</span> <span class=p>+</span> <span class=n>user</span><span class=p>.</span><span class=n>LastName</span><span class=p>);</span>
</code></pre></div><p>And because of this translation, there is essentially no difference in the expression tree that gets compiled by EF when comparing between the <code>WithoutProjectables</code> and <code>WithProjectables</code> variants.</p><p>Now that we know that we don&rsquo;t generate some special code that is perhaps better optimized compared to our manual attempt, let&rsquo;s take a step back and shift gears. What does it actually mean to call <code>.ToQueryString()</code> on either of these queries:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=kt>var</span> <span class=n>withoutProjectablesQuery</span> <span class=p>=</span> <span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span>
    <span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>FirstName</span> <span class=p>+</span> <span class=s>&#34; &#34;</span> <span class=p>+</span> <span class=n>x</span><span class=p>.</span><span class=n>LastName</span><span class=p>);</span>

<span class=kt>var</span> <span class=n>withProjectablesQuery</span> <span class=p>=</span> <span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span>
    <span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>FullName</span><span class=p>());</span>
</code></pre></div><p>We can deduce that the <code>withoutProjectablesQuery</code> is slightly more complex compared to the <code>withProjectablesQuery</code>. The former has 2 MemberAccessCalls (FirstName and LastName) as well as calls to string concatenation. The latter simply calls has a call to a static extension method (FullName), which implicitly performs the MemberAccess as well as the string concatenation. The latter&rsquo;s expression tree is thereby more compact compared to the former.</p><p>However, A simple method call to FullName is not translatable as EF has no insights into the actual implementation details. That&rsquo;s why the <a href=https://github.com/koenbeuk/EntityFrameworkCore.Projectables>EntityFrameworkCore.Projectables</a> library swaps out- at runtime, The MethodCall to FullName with the actual implementation details that was captured in the generated companion expression. We however, can still make use of the fact that an Expression of a call to FullName has a unique identity and since the implementation is determined at compile time, we can use this fact to delay the translation from the method call to FullName into it&rsquo;s appropriate implementation!</p><p>EF Core is already very well optimized and comes with a number of Extension options that are available to us. This library is using by default: <a href=https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.query.querytranslationpreprocessor>IQueryTranslationPreprocessor</a>.</p><blockquote><p>A class that preprocesses the query before translation.</p></blockquote><p>This translation hook is a perfect place to swap out the method call to FullName with its implementation details. We we&rsquo;re able to keep our call to FullName within the expression tree up to this point which means that EF Core is able to <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.query.querytranslationpreprocessor?view=efcore-5.0">cache</a> the generated SQL (which implicitly will also ensure that our preprocessor has had a chance to Expand our FullName call) while mapping it to our reduced expression tree shape. This means that even if we run our query 10 times, we only had to perform the expansion once.</p><p>I mentioned the expression tree shape. Essentially an expression tree shape is a generalized form of the expression tree where EF Core was able to swap out constants with ArgumentExpressions such that in case of the following 2 queries:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=kt>var</span> <span class=n>u1</span> <span class=p>=</span> <span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span><span class=p>.</span><span class=n>FirstOrDefault</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>Id</span> <span class=p>==</span> <span class=m>1</span><span class=p>);</span>
<span class=kt>var</span> <span class=n>u1</span> <span class=p>=</span> <span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span><span class=p>.</span><span class=n>FirstOrDefault</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>Id</span> <span class=p>==</span> <span class=m>2</span><span class=p>);</span>
</code></pre></div><p>A matching shape is generated for each which essentially says:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=kt>int</span> <span class=m>__</span><span class=n>arg1</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span> <span class=c1>// or 2
</span><span class=c1></span><span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span><span class=p>.</span><span class=n>FirstOrDefault</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>Id</span> <span class=p>==</span> <span class=m>__</span><span class=n>arg1</span><span class=p>);</span>
</code></pre></div><p>EF Core will not cache an expression tree with generated SQL but rather the shape of that expression tree with generated SQL. This has the advantage of a better cache reuse since its likely that your queries are generated dynamically. To calculate the shape of an Expression tree though, EF Core will have to Visit all expressions in a tree and build up some form of hash code that represents the shape of that tree.</p><p>By reducing the size of the expression tree due to encapsulated portions that are represented by Projectable method and property calls, we are able to reduce some of the work here! And this is why our Projectables <code>WithProjectables</code> benchmark performs better than our <code>WithoutProjectables</code> benchmark. After a first warmup run, our expansion has happened once and the generated QueryString has already been cached. In subsequent runs, EF Core can simply compute the shape of an expression tree and based on that, return the generated QueryString from cache. Since our <code>WithProjectables</code> benchmark has a compacted expression tree, the time it takes for EF Core to calculate the shape of it&rsquo;s expression tree is thereby also reduced.</p><p>Let&rsquo;s see if we can exploit the above and generate even better performing queries:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=k>const</span> <span class=kt>string</span> <span class=n>sample</span> <span class=p>=</span> <span class=s>&#34;Jon Doe&#34;</span><span class=p>;</span>
<span class=na>
</span><span class=na>[Projectable]</span>
<span class=k>public</span> <span class=k>static</span> <span class=kt>int</span> <span class=n>GetFriendsOfFriendsByFirstNameCount</span><span class=p>(</span><span class=k>this</span> <span class=n>User</span> <span class=n>user</span><span class=p>,</span> <span class=kt>string</span> <span class=n>fullName</span><span class=p>)</span>
    <span class=p>=&gt;</span> <span class=n>user</span><span class=p>.</span><span class=n>Friends</span><span class=p>.</span><span class=n>SelectMany</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>Friends</span><span class=p>).</span><span class=n>Where</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>FullName</span><span class=p>()</span> <span class=p>==</span> <span class=n>fullName</span><span class=p>).</span><span class=n>Count</span><span class=p>();</span>
<span class=na>
</span><span class=na>[Benchmark(Baseline = true)]</span>
<span class=k>public</span> <span class=k>void</span> <span class=n>WithoutProjectables</span><span class=p>()</span> <span class=p>{</span>
    <span class=kt>var</span> <span class=n>query</span> <span class=p>=</span> <span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span>
        <span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span>
            <span class=n>x</span><span class=p>.</span><span class=n>Friends</span><span class=p>.</span><span class=n>SelectMany</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>Friends</span><span class=p>).</span><span class=n>Where</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>FirstName</span> <span class=p>+</span> <span class=s>&#34; &#34;</span> <span class=p>+</span> <span class=n>x</span><span class=p>.</span><span class=n>LastName</span> <span class=p>==</span> <span class=n>sample</span><span class=p>).</span><span class=n>Count</span><span class=p>());</span>

    <span class=n>query</span><span class=p>.</span><span class=n>ToQueryString</span><span class=p>();</span>
<span class=p>}</span>
<span class=na>
</span><span class=na>[Benchmark]</span>
<span class=k>public</span> <span class=k>void</span> <span class=n>WithProjectables</span><span class=p>()</span> <span class=p>{</span>
    <span class=kt>var</span> <span class=n>query</span> <span class=p>=</span> <span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span>
        <span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>GetFriendsOfFriendsByFirstNameCount</span><span class=p>(</span><span class=n>sample</span><span class=p>));</span>

    <span class=n>query</span><span class=p>.</span><span class=n>ToQueryString</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div><p>We&rsquo;ve essentially just complicated our benchmark by putting more work in the query. In our <code>WithoutProjectables</code> implementation, EF Core has more work to do to generate the shape of the expression tree. In our <code>WithProjectables</code> implementation, this work is again encapsulated behind the Projectable method call. If we take the results of these tests then we can see the improved performance benefits:</p><table><thead><tr><th>Method</th><th style=text-align:right>Mean</th><th style=text-align:right>Error</th><th style=text-align:right>StdDev</th><th style=text-align:right>Ratio</th></tr></thead><tbody><tr><td>WithoutProjectables</td><td style=text-align:right>32.83 us</td><td style=text-align:right>0.296 us</td><td style=text-align:right>0.231 us</td><td style=text-align:right>1.00</td></tr><tr><td>WithProjectables</td><td style=text-align:right>13.77 us</td><td style=text-align:right>0.164 us</td><td style=text-align:right>0.137 us</td><td style=text-align:right>0.42</td></tr></tbody></table><p>The <code>WithProjectables</code> benchmark almost shows a 60% performance improvement over the <code>WithoutProjectables</code> benchmark! If we were to encapsulate more work inside our Projectable methods and Properties then we should expect even greater performance improvements.</p><h3 id=wrapping-up>Wrapping up</h3><p>Though the shown improvements are great, they are still limited to EF Core internally. When you actually start to send queries to your database then the difference in performance will likely be a much smaller fragment. There are also <a href=https://github.com/dotnet/efcore/issues/25009>other</a> discussions active, that focus on query pre-compilation rather than dynamic compilation. This will always outperform queries with Projectable properties and methods.</p><p>The benchmarks used in this post are as usual available on <a href=https://github.com/koenbeuk/OnTheDrift.Samples.EFCoreProjectablesPerfMagic>Github</a></p><div class=blog-tags><a href=https://www.onthedrift.com/tags/.net/>.NET</a>&nbsp;
<a href=https://www.onthedrift.com/tags/efcore/>EFCore</a>&nbsp;
<a href=https://www.onthedrift.com/tags/efcore.projectables/>EFCore.Projectables</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-projectables-perf%2f&text=EFCore.Projectables%20and%20the%20curious%20case%20of%20an%20unexpected%20performance%20boost&via=onthedrift2" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-projectables-perf%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-projectables-perf%2f&title=EFCore.Projectables%20and%20the%20curious%20case%20of%20an%20unexpected%20performance%20boost" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-projectables-perf%2f&title=EFCore.Projectables%20and%20the%20curious%20case%20of%20an%20unexpected%20performance%20boost" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-projectables-perf%2f&title=EFCore.Projectables%20and%20the%20curious%20case%20of%20an%20unexpected%20performance%20boost" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-projectables-perf%2f&description=EFCore.Projectables%20and%20the%20curious%20case%20of%20an%20unexpected%20performance%20boost" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section><h4 class=see-also>See also</h4><ul><li><a href=/posts/efcore-projectables/>EF Projections on computed properties and methods without a hassle!</a></li><li><a href=/posts/scenario-tests/>Introducing ScenarioTests, an experiment in improving the .NET testing experience</a></li><li><a href=/posts/efcore-triggered-part1/>Triggers for Entity Framework Core</a></li><li><a href=/posts/activator-utilities/>Activator utilities: activate anything!</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://www.onthedrift.com/posts/efcore-projectables/ data-toggle=tooltip data-placement=top title="EF Projections on computed properties and methods without a hassle!">&larr; Previous Post</a></li></ul><div class=disqus-comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//onthedrift.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:koen@linker.io title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/koenbeuk title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/onthedrift2 title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://stackoverflow.com/users/272424/polity title=StackOverflow><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a href title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=https://www.onthedrift.com>Koen</a>
&nbsp;&bull;&nbsp;&copy;
2021
&nbsp;&bull;&nbsp;
<a href=https://www.onthedrift.com>On The Drift</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.85.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>
&nbsp;&bull;&nbsp;[<a href=https://github.com/koenbeuk/onthedrift/tree/c63ee96902a0458c3c263ef50f8b0839bed761eb>c63ee969</a>]</p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://www.onthedrift.com/js/main.js></script><script src=https://www.onthedrift.com/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://www.onthedrift.com/js/load-photoswipe.js></script></body></html>