<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>EF Projections on computed properties and methods without a hassle! - On The Drift</title><meta name=description content="One of EF&rsquo;s main selling points is that it allows you to write queries without having to deal with the underlying database technology being used. This however has its limitations as you as a developer will have likely encountered. EFCore is only able to handle expressions that are typed as such. As a result, if you try to select anything from a locally computed property or method then EFCore will have to fall back to client-side evaluation to compute the result of that expression which may be inefficient and is certainly limiting!"><meta name=author content="Koen"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"On The Drift","url":"https:\/\/www.onthedrift.com"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/www.onthedrift.com"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/www.onthedrift.com","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/www.onthedrift.com\/posts\/efcore-projectables\/","name":"Ef projections on computed properties and methods without a hassle!"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Koen"},"headline":"EF Projections on computed properties and methods without a hassle!","description":"One of EF\u0026rsquo;s main selling points is that it allows you to write queries without having to deal with the underlying database technology being used. This however has its limitations as you as a developer will have likely encountered. EFCore is only able to handle expressions that are typed as such. As a result, if you try to select anything from a locally computed property or method then EFCore will have to fall back to client-side evaluation to compute the result of that expression which may be inefficient and is certainly limiting!","inLanguage":"en","wordCount":1616,"datePublished":"2021-06-03T00:00:00","dateModified":"2021-06-03T00:00:00","image":"https:\/\/www.onthedrift.com\/img\/avatar-squared-nobody.png","keywords":[".NET, EFCore, EFCore.Projectables"],"mainEntityOfPage":"https:\/\/www.onthedrift.com\/posts\/efcore-projectables\/","publisher":{"@type":"Organization","name":"https:\/\/www.onthedrift.com","logo":{"@type":"ImageObject","url":"https:\/\/www.onthedrift.com\/img\/avatar-squared-nobody.png","height":60,"width":60}}}</script><meta property="og:title" content="EF Projections on computed properties and methods without a hassle!"><meta property="og:description" content="One of EF&rsquo;s main selling points is that it allows you to write queries without having to deal with the underlying database technology being used. This however has its limitations as you as a developer will have likely encountered. EFCore is only able to handle expressions that are typed as such. As a result, if you try to select anything from a locally computed property or method then EFCore will have to fall back to client-side evaluation to compute the result of that expression which may be inefficient and is certainly limiting!"><meta property="og:image" content="https://www.onthedrift.com/img/avatar-squared-nobody.png"><meta property="og:url" content="https://www.onthedrift.com/posts/efcore-projectables/"><meta property="og:type" content="website"><meta property="og:site_name" content="On The Drift"><meta name=twitter:title content="EF Projections on computed properties and methods without a hassle!"><meta name=twitter:description content="One of EF&rsquo;s main selling points is that it allows you to write queries without having to deal with the underlying database technology being used. This however has its limitations as you as a â€¦"><meta name=twitter:image content="https://www.onthedrift.com/img/avatar-squared-nobody.png"><meta name=twitter:card content="summary"><meta name=twitter:site content="@onthedrift2"><meta name=twitter:creator content="@onthedrift2"><link href=https://www.onthedrift.com/img/avatar-squared-nobody.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.83.1"><link rel=alternate href=https://www.onthedrift.com/index.xml type=application/rss+xml title="On The Drift"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://www.onthedrift.com/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://www.onthedrift.com/css/highlight.min.css><link rel=stylesheet href=https://www.onthedrift.com/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://www.onthedrift.com>On The Drift</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Blog href=/>Blog</a></li><li><a title=Tags href=/tags>Tags</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="On The Drift" href=https://www.onthedrift.com><img class=avatar-img src=https://www.onthedrift.com/img/avatar-squared-nobody.png alt="On The Drift"></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=posts-heading><h1>EF Projections on computed properties and methods without a hassle!</h1><hr class=small></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p>One of EF&rsquo;s main selling points is that it allows you to write queries without having to deal with the underlying database technology being used. This however has its limitations as you as a developer will have likely encountered. EFCore is only able to handle expressions that are typed as such. As a result, if you try to select anything from a locally computed property or method then EFCore will have to fall back to client-side evaluation to compute the result of that expression which may be inefficient and is certainly limiting!</p><p>Consider the following example:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=k>public</span> <span class=k>class</span> <span class=nc>User</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=kt>int</span> <span class=n>Id</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>EmailAddress</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>FirstName</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>LastName</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

    <span class=k>public</span> <span class=kt>string</span> <span class=n>FullName</span> <span class=p>=&gt;</span> <span class=n>FirstName</span> <span class=p>+</span> <span class=s>&#34; &#34;</span> <span class=p>+</span> <span class=n>LastName</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// Our query
</span><span class=c1></span><span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span><span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>FullName</span><span class=p>).</span><span class=n>ToList</span><span class=p>();</span>
</code></pre></div><p>This query is getting compiled (targeting SQLLite) as follows:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;Id&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;EmailAddress&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;FirstName&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;LastName&#34;</span><span class=w>
</span><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;Users&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=w>
</span></code></pre></div><p>This actually works! However, there are some issues with the formerly generated query. First, we&rsquo;ve over fetched. We only really needed the FirstName and LastName. Yet our projection included the Id and EmailAddress. This may seem insignificant but once we add more properties to our user, this will build up. Secondly, this is very limiting. Imagine we want to filter on the FullName, as such:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span><span class=p>.</span><span class=n>Where</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>FullName</span><span class=p>.</span><span class=n>Contains</span><span class=p>(</span><span class=s>&#34;Jon&#34;</span><span class=p>));</span>
</code></pre></div><p>This will blow up in EF since EF is unable to translate this valid CSharp expression to SQL as it does not know how to translate FullName into a proper SQL call. We could have called <code>Users.AsEnumerable().Where(x => x.FullName.Contains("Jon"));</code> and this would have worked but again, we would be overfetching as EF would first pull in all our users into our DbContext and then perform the Where clause in memory.</p><p>We could of course re-implement the FullName property within our Query and things just work, e.g.</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span><span class=p>.</span><span class=n>Where</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>FirstName</span> <span class=p>+</span> <span class=s>&#34; &#34;</span> <span class=p>+</span> <span class=n>x</span><span class=p>.</span><span class=n>LastName</span><span class=p>).</span><span class=n>Contains</span><span class=p>(</span><span class=s>&#34;Jon&#34;</span><span class=p>));</span>
</code></pre></div><p>This works but it requires us to duplicate our logic. Luckily for us there are well-established open source libraries such as <a href=https://github.com/scottksmith95/LINQKit>LINQKit</a> that help us achieve these projections without the need to pull things in memory or write manual SQL. These libraries work by having you write Expressions that can then be used by EF and your code to both have an efficient translation to SQL (or whatever your database provider requires)- as well as be able to be computed on the client. Our hypothetical example would now look something like this:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=k>public</span> <span class=k>class</span> <span class=nc>User</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=kt>int</span> <span class=n>Id</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>EmailAddress</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>FirstName</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>LastName</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

    <span class=k>public</span> <span class=k>static</span> <span class=n>Expression</span><span class=p>&lt;</span><span class=n>Func</span><span class=p>&lt;</span><span class=n>Product</span><span class=p>,</span> <span class=kt>bool</span><span class=p>&gt;&gt;</span> <span class=n>FullName</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=n>u</span> <span class=p>=&gt;</span>  <span class=n>FirstName</span> <span class=p>+</span> <span class=s>&#34; &#34;</span> <span class=p>+</span> <span class=n>LastName</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// Our query
</span><span class=c1></span><span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span><span class=p>.</span><span class=n>AsExpandable</span><span class=p>().</span><span class=n>Select</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>FullName</span><span class=p>()).</span><span class=n>ToList</span><span class=p>();</span>
</code></pre></div><p>This will now effectively compile our LINQ Query into optimal SQL that only includes what is needed. This is what SQL Lite produces:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;Id&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;FirstName&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;LastName&#34;</span><span class=w>
</span><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;Users&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=w>
</span><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;Jon&#39;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=p>)</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=p>(</span><span class=n>instr</span><span class=p>((</span><span class=n>COALESCE</span><span class=p>(</span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;FirstName&#34;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39; &#39;</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;LastName&#34;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=p>),</span><span class=w> </span><span class=s1>&#39;Jon&#39;</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w>
</span></code></pre></div><p>We were able to filter within the produced query and only fetch the fields that we needed. Great! until we need to compute the FullName on the client. We would then have to call something like:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=n>user</span><span class=p>.</span><span class=n>FullName</span><span class=p>().</span><span class=n>Compile</span><span class=p>().</span><span class=n>Invoke</span><span class=p>(</span><span class=n>user</span><span class=p>);</span>
</code></pre></div><p>Again, not such a great experience and certainly not good for performance. We could leave them side-by-side, meaning one implementing using Expressions and one implemented as a normal computed property but that would either require us to implement FullName twice or take a performance hit.</p><p>If you recall from our LINQ Query, we also had to make a call to <code>AsExpandable()</code> to ensure that the LINQ Query would be rewritten to translate our <code>FullName()</code> call into the implementation that EF would actually understand. This again adds more complexity as well to the query and thereby also incurring a performance impact on the execution of that query.</p><p>These libraries have helpers us over time but it&rsquo;s 2021 and we have new tools in our toolbelt! introducing: <a href=https://github.com/koenbeuk/EntityFrameworkCore.Projectables>EntityFrameworkCore.Projectables</a>!</p><h3 id=efcore-projectables>EFCore Projectables</h3><p><a href=(https://github.com/koenbeuk/EntityFrameworkCore.Projectables)>EntityFrameworkCore.Projectables</a> library intends to tackle the above problems and much more! For a while now we have access to SourceGenerators. A Generator allows us to produce additional source code based on your source code. What this means is that we can now automatically produce Expression methods for your properties and methods. All you need to do is mark those properties and methods for which you&rsquo;d like an Expression method to be generated with an attribute. Perhaps that is hard to understand so let us examine what we can do with our example:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=k>public</span> <span class=k>class</span> <span class=nc>User</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=kt>int</span> <span class=n>Id</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>EmailAddress</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>FirstName</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>LastName</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
<span class=na>
</span><span class=na>    [Projectable]</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>FullName</span> <span class=p>=&gt;</span> <span class=n>FirstName</span> <span class=p>+</span> <span class=s>&#34; &#34;</span> <span class=p>+</span> <span class=n>LastName</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>All we had to do was add an Attribute on the FullName property and this will generate for us:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=k>public</span> <span class=k>static</span> <span class=k>class</span> <span class=nc>BasicSample_User_FullName</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>static</span> <span class=n>System</span><span class=p>.</span><span class=n>Linq</span><span class=p>.</span><span class=n>Expressions</span><span class=p>.</span><span class=n>Expression</span><span class=p>&lt;</span><span class=n>System</span><span class=p>.</span><span class=n>Func</span><span class=p>&lt;</span><span class=k>global</span><span class=p>::</span><span class=n>BasicSample</span><span class=p>.</span><span class=n>User</span><span class=p>,</span> <span class=kt>string</span><span class=p>&gt;&gt;</span> <span class=n>Expression</span> <span class=p>=&gt;</span> 
        <span class=p>(</span><span class=k>global</span><span class=p>::</span><span class=n>BasicSample</span><span class=p>.</span><span class=n>User</span> <span class=n>@this</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=n>@this</span><span class=p>.</span><span class=n>FirstName</span> <span class=p>+</span> <span class=s>&#34; &#34;</span> <span class=p>+</span> <span class=n>@this</span><span class=p>.</span><span class=n>LastName</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>We&rsquo;ve received a new class (tugged away in a namespace: <code>EntityFrameworkCore.Projectables.Generated</code>) that contains a companion Expression of our FullName implementation. This is great, but how can we use it? Well, we just call it in our query!</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span><span class=p>.</span><span class=n>Where</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>FullName</span><span class=p>.</span><span class=n>Contains</span><span class=p>(</span><span class=s>&#34;Jon&#34;</span><span class=p>));</span>
</code></pre></div><p>This query should blow up, right? We did not make a call to <code>AsExapandable</code> as we did before. How does EF know to use our generated expression instead of our normal property?</p><p>This query will translate to SQL perfectly fine without over fetching, for as long as we&rsquo;ve enabled Projectables with our DbContext. How do we do that? We call <code>UseProjectables()</code> on our OptionsBuilder! e.g. in case of using DI:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=n>serviceProvider</span><span class=p>.</span><span class=n>AddDbContext</span><span class=p>&lt;</span><span class=n>ApplicationDbContext</span><span class=p>&gt;(</span><span class=n>options</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=n>options</span>
            <span class=p>.</span><span class=n>UseSqlite</span><span class=p>(...)</span>
            <span class=p>.</span><span class=n>UseProjections</span><span class=p>();</span>
    <span class=p>})</span>

</code></pre></div><p>Or when not using DI:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=k>override</span> <span class=k>void</span> <span class=n>OnConfiguring</span><span class=p>(</span><span class=n>DbContextOptionsBuilder</span> <span class=n>optionsBuilder</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>optionsBuilder</span><span class=p>.</span><span class=n>UseSqlServer</span><span class=p>(...);</span>
    <span class=n>optionsBuilder</span><span class=p>.</span><span class=n>UseProjections</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div><p>At this stage, EF is fully equipped to translate any query that queries on a property or method that is marked with <code>[Projectable]</code> to use the source generated version internally. Since this happens early in the processing pipeline, no additional performance overhead is essentially added as EFCore does a great job in caching compiled queries.</p><p>What this then allows us to do is something as the following:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=kt>var</span>  <span class=n>users</span> <span class=p>=</span> <span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span><span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=k>new</span> <span class=p>{</span> <span class=n>x</span><span class=p>.</span><span class=n>Id</span><span class=p>,</span> <span class=n>x</span><span class=p>.</span><span class=n>FullName</span> <span class=p>});</span>
<span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>user</span> <span class=k>in</span> <span class=n>users</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>user</span><span class=p>.</span><span class=n>FullName</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>Our generated SQL would hence be as simple as:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;Id&#34;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>COALESCE</span><span class=p>(</span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;FirstName&#34;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39; &#39;</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;LastName&#34;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;FullName&#34;</span><span class=w>
</span><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;Users&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=w>
</span></code></pre></div><p>We have everything that we wanted. No over-fetching, no performance overhead and essentially no additional code except for our added <code>Projectable</code> attribute.</p><h3 id=real-world-scenarios>Real world scenarios</h3><p>So far so good, We&rsquo;ve been able to query a very simple projectable property. But what about a more complicated example. Let say our User has Orders and we want to have a computed property exposed on the User that can tell us how much this user has spent so far on all Orders. Perhaps something like this:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=p>...</span>

<span class=k>public</span> <span class=k>class</span> <span class=nc>Order</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=k>public</span> <span class=n>ICollection</span><span class=p>&lt;</span><span class=n>Item</span><span class=p>&gt;</span> <span class=n>Items</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
<span class=na>
</span><span class=na>    [Projectable]</span> <span class=k>public</span> <span class=kt>double</span> <span class=n>PriceSum</span> <span class=p>=&gt;</span> <span class=n>Items</span><span class=p>.</span><span class=n>Sum</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>TotalPrice</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>public</span> <span class=k>class</span> <span class=nc>User</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=k>public</span> <span class=n>ICollection</span><span class=p>&lt;</span><span class=n>Order</span><span class=p>&gt;</span> <span class=n>Orders</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
<span class=na>
</span><span class=na>    [Projectable]</span> <span class=k>public</span> <span class=kt>double</span> <span class=n>TotalSpent</span> <span class=p>=&gt;</span> <span class=n>Orders</span><span class=p>.</span><span class=n>Sum</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>PriceSum</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>var</span> <span class=n>mostValuableUser</span> <span class=p>=</span> <span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span>
    <span class=p>.</span><span class=n>OrderByDescending</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>TotalSpent</span><span class=p>)</span>
    <span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>Id</span><span class=p>)</span>
    <span class=p>.</span><span class=n>FirstOrDefault</span><span class=p>();</span>
</code></pre></div><p>What this query would generate should be of no suprise:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;Id&#34;</span><span class=w>
</span><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;Users&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=w>
</span><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>((</span><span class=w>
</span><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=k>CAST</span><span class=p>(</span><span class=s2>&#34;o&#34;</span><span class=p>.</span><span class=s2>&#34;Quantity&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>REAL</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=s2>&#34;o&#34;</span><span class=p>.</span><span class=s2>&#34;UnitPrice&#34;</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;OrderItem&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;o&#34;</span><span class=w>
</span><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=s2>&#34;o0&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;o&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=p>)),</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;Order&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;o0&#34;</span><span class=w>
</span><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;Id&#34;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;o0&#34;</span><span class=p>.</span><span class=s2>&#34;UserId&#34;</span><span class=p>)</span><span class=w> </span><span class=k>DESC</span><span class=w>
</span><span class=w></span><span class=k>LIMIT</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></code></pre></div><p>We really have an optimized query here. Note that we are able to call <code>PriceSum</code> on OrderItems which in itself is another <code>Projectable</code> property and EF was able to translate to its Expression implementation.</p><p>So what about calling into Methods and especially if these methods take in additional arguments? We can serve those too!</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=k>public</span> <span class=k>class</span> <span class=nc>User</span> <span class=p>{</span>
    <span class=p>...</span>
<span class=na>    [Projectable]</span>
    <span class=k>public</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>Order</span><span class=p>&gt;</span> <span class=n>GetRecentOrders</span><span class=p>(</span><span class=n>DateTime</span> <span class=n>createdAfterDate</span><span class=p>)</span> 
        <span class=p>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=n>Orders</span><span class=p>.</span><span class=n>Where</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>CreatedDate</span> <span class=p>&gt;</span> <span class=n>createdAfterDate</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// Our query again
</span><span class=c1></span><span class=kt>var</span> <span class=n>createdAfterDate</span> <span class=p>=</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>UtcNow</span><span class=p>.</span><span class=n>AddDays</span><span class=p>(-</span><span class=m>7</span><span class=p>);</span> <span class=c1>// Orders created within the last 7 days
</span><span class=c1></span><span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span><span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=k>new</span> <span class=p>{</span>
    <span class=n>UserId</span> <span class=p>=</span> <span class=n>x</span><span class=p>.</span><span class=n>Id</span><span class=p>,</span>
    <span class=n>Orders</span> <span class=p>=</span> <span class=n>x</span><span class=p>.</span><span class=n>GetRecentOrders</span><span class=p>(</span><span class=n>createdAfterDate</span><span class=p>)</span>
<span class=p>})</span>
</code></pre></div><p>This again provides us with the following SQL:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;Id&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;t&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;t&#34;</span><span class=p>.</span><span class=s2>&#34;CreatedDate&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;t&#34;</span><span class=p>.</span><span class=s2>&#34;ProductId&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;t&#34;</span><span class=p>.</span><span class=s2>&#34;UserId&#34;</span><span class=w>
</span><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;Users&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=w>
</span><span class=w></span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=s2>&#34;o&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;o&#34;</span><span class=p>.</span><span class=s2>&#34;CreatedDate&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;o&#34;</span><span class=p>.</span><span class=s2>&#34;ProductId&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;o&#34;</span><span class=p>.</span><span class=s2>&#34;UserId&#34;</span><span class=w>
</span><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;Order&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;o&#34;</span><span class=w>
</span><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=s2>&#34;o&#34;</span><span class=p>.</span><span class=s2>&#34;CreatedDate&#34;</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=o>@</span><span class=n>__createdAfterdate_0</span><span class=w>
</span><span class=w></span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;t&#34;</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;Id&#34;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;t&#34;</span><span class=p>.</span><span class=s2>&#34;UserId&#34;</span><span class=w>
</span><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;Id&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;t&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=w>
</span></code></pre></div><p>Our CreatedAfterDate argument was captured as a parameter and passed in such that our query plan can effectively be compiled and reused.</p><p>Lets take this on step further. We want to have an extension method that helps us find the most valuable recent order that has a value over whatever we give it. Let&rsquo;s look at our scenario first:</p><div class=highlight><pre class=chroma><code class=language-csharp data-lang=csharp><span class=k>public</span> <span class=k>static</span> <span class=k>class</span> <span class=nc>UserExtensions</span> <span class=p>{</span>
    <span class=k>public</span> <span class=k>static</span> <span class=n>Order</span> <span class=n>GetMostValuableRecentOrder</span><span class=p>(</span><span class=k>this</span> <span class=n>User</span> <span class=n>user</span><span class=p>,</span> <span class=n>DateTime</span> <span class=n>createdAfterDate</span><span class=p>,</span> <span class=kt>double</span> <span class=n>minimumValueToBeConsidered</span><span class=p>)</span> 
        <span class=p>=&gt;</span> <span class=n>user</span><span class=p>.</span><span class=n>Orders</span>
            <span class=p>.</span><span class=n>Where</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>CreatedDate</span> <span class=p>&gt;</span> <span class=n>createdAfterDate</span><span class=p>)</span>
            <span class=p>.</span><span class=n>Where</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>PriceSum</span> <span class=p>&gt;=</span> <span class=n>minimumValueToBeConsidered</span><span class=p>)</span>
            <span class=p>.</span><span class=n>OrderByDescending</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>PriceSum</span><span class=p>)</span>
            <span class=p>.</span><span class=n>FirstOrDefault</span><span class=p>();</span>
<span class=p>}</span>

<span class=c1>// And our query again
</span><span class=c1></span><span class=kt>var</span> <span class=n>query</span> <span class=p>=</span> <span class=n>dbContext</span><span class=p>.</span><span class=n>Users</span>
    <span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=k>new</span> <span class=p>{</span>
        <span class=n>Name</span> <span class=p>=</span> <span class=n>x</span><span class=p>.</span><span class=n>FullName</span><span class=p>,</span>
        <span class=n>TotalSpent</span> <span class=p>=</span> <span class=m>0</span><span class=c1>//x.TotalSpent
</span><span class=c1></span>    <span class=p>})</span>
    <span class=p>.</span><span class=n>OrderByDescending</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>TotalSpent</span><span class=p>);</span>
</code></pre></div><p>And when we execute our SQL we get something that is slightly unexpected:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=p>(</span><span class=n>COALESCE</span><span class=p>(</span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;FirstName&#34;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39; &#39;</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;LastName&#34;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=p>),</span><span class=w> </span><span class=s2>&#34;t0&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;t0&#34;</span><span class=p>.</span><span class=s2>&#34;CreatedDate&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;t0&#34;</span><span class=p>.</span><span class=s2>&#34;ProductId&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;t0&#34;</span><span class=p>.</span><span class=s2>&#34;UserId&#34;</span><span class=w>
</span><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;Users&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=w>
</span><span class=w></span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=s2>&#34;t&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;t&#34;</span><span class=p>.</span><span class=s2>&#34;CreatedDate&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;t&#34;</span><span class=p>.</span><span class=s2>&#34;ProductId&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;t&#34;</span><span class=p>.</span><span class=s2>&#34;UserId&#34;</span><span class=w>
</span><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=s2>&#34;o0&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;o0&#34;</span><span class=p>.</span><span class=s2>&#34;CreatedDate&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;o0&#34;</span><span class=p>.</span><span class=s2>&#34;ProductId&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;o0&#34;</span><span class=p>.</span><span class=s2>&#34;UserId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ROW_NUMBER</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=p>(</span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=s2>&#34;o0&#34;</span><span class=p>.</span><span class=s2>&#34;UserId&#34;</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>            </span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=k>CAST</span><span class=p>(</span><span class=s2>&#34;o&#34;</span><span class=p>.</span><span class=s2>&#34;Quantity&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>REAL</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=s2>&#34;o&#34;</span><span class=p>.</span><span class=s2>&#34;UnitPrice&#34;</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span><span class=w>            </span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;OrderItem&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;o&#34;</span><span class=w>
</span><span class=w>            </span><span class=k>WHERE</span><span class=w> </span><span class=s2>&#34;o0&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;o&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=p>)</span><span class=w> </span><span class=k>DESC</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;row&#34;</span><span class=w>
</span><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;Order&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;o0&#34;</span><span class=w>
</span><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=p>(</span><span class=s2>&#34;o0&#34;</span><span class=p>.</span><span class=s2>&#34;CreatedDate&#34;</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=o>@</span><span class=n>__createdAfterdate_0</span><span class=p>)</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>((</span><span class=w>
</span><span class=w>            </span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=k>CAST</span><span class=p>(</span><span class=s2>&#34;o1&#34;</span><span class=p>.</span><span class=s2>&#34;Quantity&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>REAL</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=s2>&#34;o1&#34;</span><span class=p>.</span><span class=s2>&#34;UnitPrice&#34;</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span><span class=w>            </span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;OrderItem&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;o1&#34;</span><span class=w>
</span><span class=w>            </span><span class=k>WHERE</span><span class=w> </span><span class=s2>&#34;o0&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;o1&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=o>@</span><span class=n>__minimumValueToBeConsidered_1</span><span class=p>)</span><span class=w>
</span><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;t&#34;</span><span class=w>
</span><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=s2>&#34;t&#34;</span><span class=p>.</span><span class=s2>&#34;row&#34;</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span><span class=w></span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;t0&#34;</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;Id&#34;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;t0&#34;</span><span class=p>.</span><span class=s2>&#34;UserId&#34;</span><span class=w>
</span><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=k>CAST</span><span class=p>(</span><span class=s2>&#34;o2&#34;</span><span class=p>.</span><span class=s2>&#34;Quantity&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>REAL</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=s2>&#34;o2&#34;</span><span class=p>.</span><span class=s2>&#34;UnitPrice&#34;</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;OrderItem&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;o2&#34;</span><span class=w>
</span><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=s2>&#34;o3&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=w>
</span><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;Order&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;o3&#34;</span><span class=w>
</span><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=p>((</span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;Id&#34;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;o3&#34;</span><span class=p>.</span><span class=s2>&#34;UserId&#34;</span><span class=p>)</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>(</span><span class=s2>&#34;o3&#34;</span><span class=p>.</span><span class=s2>&#34;CreatedDate&#34;</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=o>@</span><span class=n>__createdAfterdate_0</span><span class=p>))</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>((</span><span class=w>
</span><span class=w>            </span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=k>CAST</span><span class=p>(</span><span class=s2>&#34;o4&#34;</span><span class=p>.</span><span class=s2>&#34;Quantity&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>REAL</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=s2>&#34;o4&#34;</span><span class=p>.</span><span class=s2>&#34;UnitPrice&#34;</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span><span class=w>            </span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;OrderItem&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;o4&#34;</span><span class=w>
</span><span class=w>            </span><span class=k>WHERE</span><span class=w> </span><span class=s2>&#34;o3&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;o4&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=o>@</span><span class=n>__minimumValueToBeConsidered_1</span><span class=p>)</span><span class=w>
</span><span class=w>        </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>            </span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=k>CAST</span><span class=p>(</span><span class=s2>&#34;o5&#34;</span><span class=p>.</span><span class=s2>&#34;Quantity&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>REAL</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=s2>&#34;o5&#34;</span><span class=p>.</span><span class=s2>&#34;UnitPrice&#34;</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span><span class=w>            </span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;OrderItem&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;o5&#34;</span><span class=w>
</span><span class=w>            </span><span class=k>WHERE</span><span class=w> </span><span class=s2>&#34;o3&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;o5&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=p>)</span><span class=w> </span><span class=k>DESC</span><span class=w>
</span><span class=w>        </span><span class=k>LIMIT</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>((</span><span class=w>
</span><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=s2>&#34;o6&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=w>
</span><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;Order&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;o6&#34;</span><span class=w>
</span><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=p>((</span><span class=s2>&#34;u&#34;</span><span class=p>.</span><span class=s2>&#34;Id&#34;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;o6&#34;</span><span class=p>.</span><span class=s2>&#34;UserId&#34;</span><span class=p>)</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>(</span><span class=s2>&#34;o6&#34;</span><span class=p>.</span><span class=s2>&#34;CreatedDate&#34;</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=o>@</span><span class=n>__createdAfterdate_0</span><span class=p>))</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>((</span><span class=w>
</span><span class=w>            </span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=k>CAST</span><span class=p>(</span><span class=s2>&#34;o7&#34;</span><span class=p>.</span><span class=s2>&#34;Quantity&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>REAL</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=s2>&#34;o7&#34;</span><span class=p>.</span><span class=s2>&#34;UnitPrice&#34;</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span><span class=w>            </span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;OrderItem&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;o7&#34;</span><span class=w>
</span><span class=w>            </span><span class=k>WHERE</span><span class=w> </span><span class=s2>&#34;o6&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;o7&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=o>@</span><span class=n>__minimumValueToBeConsidered_1</span><span class=p>)</span><span class=w>
</span><span class=w>        </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>            </span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=k>CAST</span><span class=p>(</span><span class=s2>&#34;o8&#34;</span><span class=p>.</span><span class=s2>&#34;Quantity&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>REAL</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=s2>&#34;o8&#34;</span><span class=p>.</span><span class=s2>&#34;UnitPrice&#34;</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span><span class=w>            </span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;OrderItem&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s2>&#34;o8&#34;</span><span class=w>
</span><span class=w>            </span><span class=k>WHERE</span><span class=w> </span><span class=s2>&#34;o6&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;o8&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=p>)</span><span class=w> </span><span class=k>DESC</span><span class=w>
</span><span class=w>        </span><span class=k>LIMIT</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;o2&#34;</span><span class=p>.</span><span class=s2>&#34;OrderId&#34;</span><span class=p>))</span><span class=w> </span><span class=k>DESC</span><span class=w>
</span></code></pre></div><p>We can see multiple projectable properties and methods at work here. First we&rsquo;ve shown that we can query on extension methods as long as they are marked as Projectables. We can subsequently call additional projectable properties and methods and all can make use of parameters that we passed in. The generated SQL however is less than optimal and we could do better by manually writing SQL. This however is unrelated to this project and more of an issue with what EF and its database provider can do at the moment.</p><h3 id=conclusion>Conclusion</h3><p><a href=https://github.com/koenbeuk/EntityFrameworkCore.Projectables>EntityFrameworkCore.Projectables</a> is a great tool to have when working within the confines of EFCore. It allows us to write our logic once and reuse it both within our queries as well as on the client-side. With great power comes great responsibilities though as we may be better off just embracing our database and use stored procedures for optimal performance. Regardless. Using Projectables enables a whole new set of paradigms that were difficult to achieve without it. I hence strongly suggest you checkout this project and see how it works for you.</p><div class=blog-tags><a href=https://www.onthedrift.com/tags/.net/>.NET</a>&nbsp;
<a href=https://www.onthedrift.com/tags/efcore/>EFCore</a>&nbsp;
<a href=https://www.onthedrift.com/tags/efcore.projectables/>EFCore.Projectables</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-projectables%2f&text=EF%20Projections%20on%20computed%20properties%20and%20methods%20without%20a%20hassle%21&via=onthedrift2" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-projectables%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-projectables%2f&title=EF%20Projections%20on%20computed%20properties%20and%20methods%20without%20a%20hassle%21" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-projectables%2f&title=EF%20Projections%20on%20computed%20properties%20and%20methods%20without%20a%20hassle%21" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-projectables%2f&title=EF%20Projections%20on%20computed%20properties%20and%20methods%20without%20a%20hassle%21" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-projectables%2f&description=EF%20Projections%20on%20computed%20properties%20and%20methods%20without%20a%20hassle%21" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section><h4 class=see-also>See also</h4><ul><li><a href=/posts/scenario-tests/>Introducing ScenarioTests, an experiment in improving the .NET testing experience</a></li><li><a href=/posts/efcore-triggered-part1/>Triggers for Entity Framework Core</a></li><li><a href=/posts/activator-utilities/>Activator utilities: activate anything!</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://www.onthedrift.com/posts/scenario-tests/ data-toggle=tooltip data-placement=top title="Introducing ScenarioTests, an experiment in improving the .NET testing experience">&larr; Previous Post</a></li></ul><div class=disqus-comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//onthedrift.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:koen@linker.io title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/koenbeuk title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/onthedrift2 title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://stackoverflow.com/users/272424/polity title=StackOverflow><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a href title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=https://www.onthedrift.com>Koen</a>
&nbsp;&bull;&nbsp;&copy;
2021
&nbsp;&bull;&nbsp;
<a href=https://www.onthedrift.com>On The Drift</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.83.1</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>
&nbsp;&bull;&nbsp;[<a href=https://github.com/koenbeuk/onthedrift/tree/d68f2bd04c50976c2f0079c809ca81d19f581dcc>d68f2bd0</a>]</p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://www.onthedrift.com/js/main.js></script><script src=https://www.onthedrift.com/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://www.onthedrift.com/js/load-photoswipe.js></script></body></html>