<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Triggers for Entity Framework Core - On The Drift</title><meta name=description content="When our codebase grows, so does its complexity. One way of managing this growing complexity is by leveraging triggers. Essentially this means that we’re able to run arbitrary code whenever a database commit occurs. Luckily for us, EF Core already provides the necessary infrastructure to embrace triggers. All we need to add is a bit of plumbing. EntityFrameworkCore.Triggered is a NuGet package that does just that. The source can be found over on Github."><meta name=author content="Koen"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"On The Drift","url":"https:\/\/www.onthedrift.com"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/www.onthedrift.com"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/www.onthedrift.com","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/www.onthedrift.com\/posts\/efcore-triggered-part1\/","name":"Triggers for entity framework core"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Koen"},"headline":"Triggers for Entity Framework Core","description":"When our codebase grows, so does its complexity. One way of managing this growing complexity is by leveraging triggers. Essentially this means that we’re able to run arbitrary code whenever a database commit occurs. Luckily for us, EF Core already provides the necessary infrastructure to embrace triggers. All we need to add is a bit of plumbing. EntityFrameworkCore.Triggered is a NuGet package that does just that. The source can be found over on Github.","inLanguage":"en","wordCount":1467,"datePublished":"2021-04-23T00:00:00","dateModified":"2021-04-23T00:00:00","image":"https:\/\/www.onthedrift.com\/img\/avatar-squared-nobody.png","keywords":[".NET, EFCore, EFCore.Triggered"],"mainEntityOfPage":"https:\/\/www.onthedrift.com\/posts\/efcore-triggered-part1\/","publisher":{"@type":"Organization","name":"https:\/\/www.onthedrift.com","logo":{"@type":"ImageObject","url":"https:\/\/www.onthedrift.com\/img\/avatar-squared-nobody.png","height":60,"width":60}}}</script><meta property="og:title" content="Triggers for Entity Framework Core"><meta property="og:description" content="When our codebase grows, so does its complexity. One way of managing this growing complexity is by leveraging triggers. Essentially this means that we’re able to run arbitrary code whenever a database commit occurs. Luckily for us, EF Core already provides the necessary infrastructure to embrace triggers. All we need to add is a bit of plumbing. EntityFrameworkCore.Triggered is a NuGet package that does just that. The source can be found over on Github."><meta property="og:image" content="https://www.onthedrift.com/img/avatar-squared-nobody.png"><meta property="og:url" content="https://www.onthedrift.com/posts/efcore-triggered-part1/"><meta property="og:type" content="website"><meta property="og:site_name" content="On The Drift"><meta name=twitter:title content="Triggers for Entity Framework Core"><meta name=twitter:description content="When our codebase grows, so does its complexity. One way of managing this growing complexity is by leveraging triggers. Essentially this means that we’re able to run arbitrary code whenever a database …"><meta name=twitter:image content="https://www.onthedrift.com/img/avatar-squared-nobody.png"><meta name=twitter:card content="summary"><meta name=twitter:site content="@onthedrift2"><meta name=twitter:creator content="@onthedrift2"><link href=https://www.onthedrift.com/img/avatar-squared-nobody.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.109.0"><link rel=alternate href=https://www.onthedrift.com/index.xml type=application/rss+xml title="On The Drift"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://www.onthedrift.com/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://www.onthedrift.com/css/highlight.min.css><link rel=stylesheet href=https://www.onthedrift.com/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://www.onthedrift.com>On The Drift</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Blog href=/>Blog</a></li><li><a title=Tags href=/tags>Tags</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="On The Drift" href=https://www.onthedrift.com><img class=avatar-img src=https://www.onthedrift.com/img/avatar-squared-nobody.png alt="On The Drift"></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=posts-heading><h1>Triggers for Entity Framework Core</h1><hr class=small></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p>When our codebase grows, so does its complexity. One way of managing this growing complexity is by leveraging triggers. Essentially this means that we’re able to run arbitrary code whenever a database commit occurs. Luckily for us, EF Core already provides the necessary infrastructure to embrace triggers. All we need to add is a bit of plumbing.
<a href=https://www.nuget.org/packages/EntityFrameworkCore.Triggered>EntityFrameworkCore.Triggered</a> is a NuGet package that does just that. The source can be found over on <a href=https://github.com/koenbeuk/EntityFrameworkCore.Triggered>Github</a>.
This is part 1 in a series on EntityFrameworkCore.Triggered</p><h2 id=motivation>Motivation</h2><p>Having worked on different projects involving Entity Framework, I noticed a pattern where we often want to do ‘something’ in response to an action. Some examples of that are:</p><ul><li>Automatically assign a CreatedOn / UpdatedOn timestamp when adding/updating a record.</li><li>Validate the password strength before committing a user account to the database.</li><li>Sending an email whenever an order gets placed.</li><li>Update an aggregate whenever we update a record.</li><li>Implementing a soft-delete strategy</li></ul><p>Some of these could be done using database triggers. Database triggers are a technique where we can have arbitrary code invoked in response to an action in your database. For example, we could enforce the constraint to always assign a CreatedOn timestamp to a new record by creating an AFTER INSERT database trigger that then updates the CreatedOn column for added records. Here is an example of an AFTER INSERT trigger for SQL Server:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TRIGGER</span><span class=w> </span><span class=n>User_Enforce_CreatedOn</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>dbo</span><span class=p>.</span><span class=n>Users</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FOR</span><span class=w> </span><span class=k>INSERT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>UPDATE</span><span class=w> </span><span class=n>Users</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>CreatedOn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GETDATE</span><span class=p>()</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>Id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Inserted</span><span class=p>.</span><span class=n>Id</span><span class=w>
</span></span></span></code></pre></div><p>This sounds great but it comes with a few gotchas:</p><ul><li>Database triggers, as the name suggests, are database-centric. Some databases may not support them and others may support only specific features. EFCore has no native support for database triggers. Your luck may vary from database to database.</li><li>In the given example, we update a record after its inserted, Depending on your database, this can be bad for performance and can cause unexpected side effects (in this example, a hypothetical trigger that would update the UpdatedOn column of an updated record would get invoked because our record got updated in order to set the CreatedOn value).</li><li>Database triggers are restricted to the database. Sending out an email in response to something happening in your database is, though technically with most databases possible, not easy to implement- nor a recommended use of database triggers.</li></ul><p>Database triggers are for these reasons great for specific purposes: They can absolutely enforce certain data integrity constraints. No matter how a record got inserted, updated, or removed, we can pretty much ensure that all database triggers will have had a chance to run in accordance. They are however invisible to the rest of the application and unable to interact with it. We need something that gives us more control.</p><p>In comes the good old service class. Here is an example of a typical service class using EF Core:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>UserService</span> <span class=p>:</span> <span class=n>IUserService</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>int</span> <span class=n>Add</span><span class=p>(</span><span class=n>UserTemplate</span> <span class=n>template</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>user</span> <span class=p>=</span> <span class=k>new</span> <span class=n>User</span><span class=p>(</span><span class=n>template</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 1. Enforce that the CreatedOn property is always set </span>
</span></span><span class=line><span class=cl>        <span class=n>user</span><span class=p>.</span><span class=n>CreatedOn</span> <span class=p>=</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>Now</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 2. Add a &#39;welcoming&#39; email to the database</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>welcomeEmail</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Email</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>User</span> <span class=p>=</span> <span class=n>user</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Message</span><span class=p>:</span> <span class=s>&#34;Welcome to the club!...&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=n>_applicationDbContext</span><span class=p>.</span><span class=n>Emails</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>welcomeEmail</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>_applicationDbContext</span><span class=p>.</span><span class=n>Users</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>_applicationDbContext</span><span class=p>.</span><span class=n>SaveChanges</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 3. Ensure that we send the email out (but only after we&#39;ve ensured that everything got committed to the database)</span>
</span></span><span class=line><span class=cl>        <span class=n>_emailService</span><span class=p>.</span><span class=n>Send</span><span class=p>(</span><span class=n>welcomeEmail</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>user</span><span class=p>.</span><span class=n>Id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This is a technique that overcomes all of the above-mentioned limitations with database triggers. It leans on EF Core and therefore is database agnostic. We can set certain properties and do verification before the record gets committed to the database, thereby only causing one INSERT statement. Finally, we can interact with the rest of the application and therefore interact with e.g. our Email service. However, it does come with a few limitations on its own:</p><ul><li>This can get messy, fast! the more our application grows, the more business rules we get to enforce, the more code we get to slap onto this service. Single-responsibility is not with this one which makes it much harder to maintain and test.</li><li>Similar to the previous point, code reuse becomes more of a pain. If the User entity inherits from a BaseEntity which in turn enforces the CreatedOn property to be set, we will either have to do it ourselves or use inheritance or encapsulation to comply with that requirement.</li><li>We&rsquo;re unable to enforce the use of our service. If we want to guarantee that the welcome email address is created and sent out, we will still have to either enforce strict discipline to ever only add new users by using the UserService- or find an alternative way of enforcing that rule.</li></ul><p>There must be a better way of going about this&mldr;</p><blockquote><p>I am aware of <a href=https://github.com/jbogard/MediatR>MediatR</a> and <a href=https://github.com/JonPSmith/EfCore.GenericEventRunner>EfCore.GenericEventRunner</a>. These libraries offer an alternative approach to dealing with this added complexity. I have opinions on these approaches and I think that they can complement EntityFrameworkCore.Triggered in many ways. I will not discuss them further in this article but I will probably come back on these projects in a later post.</p></blockquote><h2 id=entityframeworkcoretriggered>EntityFrameworkCore.Triggered</h2><p>By bringing Triggers into EntityFrameworkCore we can create a hybrid between both approaches. With EntityFrameworkCore.Triggered, we&rsquo;re able to do this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>SetCreatedOnDate</span> <span class=p>:</span> <span class=n>IBeforeSaveTrigger</span><span class=p>&lt;</span><span class=n>User</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>Task</span> <span class=n>BeforeSave</span><span class=p>(</span><span class=n>ITriggerContext</span><span class=p>&lt;</span><span class=n>User</span><span class=p>&gt;</span> <span class=n>context</span><span class=p>,</span> <span class=n>CancellationToken</span> <span class=n>cancellationToken</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=n>ChangeType</span> <span class=p>==</span> <span class=n>ChangeType</span><span class=p>.</span><span class=n>Added</span><span class=p>){</span> 
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=p>.</span><span class=n>Entity</span><span class=p>.</span><span class=n>CreatedOn</span> <span class=p>=</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>Now</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Task</span><span class=p>.</span><span class=n>CompletedTask</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This ensures that for as long as we use our DbContext is used. the CreatedOn property will be set when a new user gets added to the database. Because this is a single class with a single responsibility, it&rsquo;s trivial to write appropriate unit tests to ensure its correct behavior.</p><p>We can then use the same technique to enforce our second requirement, which is to create a Welcome email for this new user. Since triggers are registered and resolved through dependency injection, we can easily enforce this rule:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>CreateWelcomeEmail</span> <span class=p>:</span> <span class=n>IBeforeSaveTrigger</span><span class=p>&lt;</span><span class=n>User</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>readonly</span> <span class=n>ApplicationDbContext</span> <span class=n>_applicationDbContext</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>CreateWelcomeEmail</span><span class=p>(</span><span class=n>ApplicationDbContext</span> <span class=n>applicationDbContext</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>_applicationDbContext</span> <span class=p>=</span> <span class=n>applicationDbContext</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>Task</span> <span class=n>BeforeSave</span><span class=p>(</span><span class=n>ITriggerContext</span><span class=p>&lt;</span><span class=n>User</span><span class=p>&gt;</span> <span class=n>context</span><span class=p>,</span> <span class=n>CancellationToken</span> <span class=n>cancellationToken</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=n>ChangeType</span> <span class=p>==</span> <span class=n>ChangeType</span><span class=p>.</span><span class=n>Added</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=n>_applicationDbContext</span><span class=p>.</span><span class=n>Emails</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=k>new</span> <span class=n>Email</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>User</span> <span class=p>=</span> <span class=n>user</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>Message</span><span class=p>:</span> <span class=s>&#34;Welcome to the club!...&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Task</span><span class=p>.</span><span class=n>CompletedTask</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Note that we&rsquo;re not sending the email out here, we&rsquo;re only worried about creating the email. EntityFrameworkCore.Triggered by default supports recursion which means that changes to your DbContext from within your triggers will be recorded and subsequent triggers will be raised accordingly.</p><p>Enforcing the rule to sending out the actual email is for that reason not much different:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>SendEmail</span> <span class=p>:</span> <span class=n>IAfterSaveTrigger</span><span class=p>&lt;</span><span class=n>Email</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>readonly</span> <span class=n>EmailSendService</span> <span class=n>_emailSendService</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>CreateWelcomeEmail</span><span class=p>(</span><span class=n>IEmailSendService</span> <span class=n>emailSendService</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>_emailSendService</span> <span class=p>=</span> <span class=n>emailSendService</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>Task</span> <span class=n>AfterSave</span><span class=p>(</span><span class=n>ITriggerContext</span><span class=p>&lt;</span><span class=n>Email</span><span class=p>&gt;</span> <span class=n>context</span><span class=p>,</span> <span class=n>CancellationToken</span> <span class=n>cancellationToken</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=n>ChangeType</span> <span class=p>==</span> <span class=n>ChangeType</span><span class=p>.</span><span class=n>Added</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>            <span class=n>_emailSendService</span><span class=p>.</span><span class=n>Send</span><span class=p>(</span><span class=n>email</span><span class=p>);</span> <span class=c1>// Initial email</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=n>ChangeType</span> <span class=p>==</span> <span class=n>ChangeType</span><span class=p>.</span><span class=n>Modified</span> <span class=p>&amp;&amp;</span> <span class=n>context</span><span class=p>.</span><span class=n>Entity</span><span class=p>.</span><span class=n>Message</span> <span class=p>!=</span> <span class=n>context</span><span class=p>.</span><span class=n>UnmodifiedEntity</span><span class=p>.</span><span class=n>Message</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>_emailSendService</span><span class=p>.</span><span class=n>Send</span><span class=p>(</span><span class=n>email</span><span class=p>);</span> <span class=c1>// In case the content was updated we want to resent this email</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Task</span><span class=p>.</span><span class=n>CompletedTask</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>A few things to note here:</p><ul><li>Instead of implementing IBeforeSaveTrigger, we&rsquo;ve to implement IAfterSaveTrigger which as the name suggests runs after EFCores SaveChanges completes.</li><li>Instead of having this tied to the UserService, we&rsquo;ve created a generic implementation that instead triggers on email records. Now any email that gets created or modified will automatically be sent out by this trigger.</li><li>We also have implemented a &lsquo;requirement&rsquo; where whenever the message of an email record changes, we want to resend that email with the new message. This way we can show that triggers can invoke for all Insert/Modified/Deleted entities. We&rsquo;ve also shown that we can access the current state of the entity using <code>Context.Entity</code> as well as the unmodified form using <code>Context.UnmodifiedEntity</code>. This as the example shows us, is great to test for property changes and can be used in all our trigger types including <code>IBeforeSaveTriggers</code>.</li></ul><h3 id=configuring-triggers>Configuring triggers</h3><p>In the above <code>SendEmail</code> trigger we made use of an <code>IEmailSendService</code> instance but where did it come from? As it turns out, Triggers are perfectly able to interact with your dependency injection container. Lets take a look at what a typical setup would look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>void</span> <span class=n>ConfigureServices</span><span class=p>(</span><span class=n>IServiceCollection</span> <span class=n>services</span><span class=p>)</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>services</span><span class=p>.</span><span class=n>AddDbContext</span><span class=p>&lt;</span><span class=n>ApplicationDbContext</span><span class=p>&gt;(</span><span class=n>options</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>options</span><span class=p>.</span><span class=n>UseSqlServer</span><span class=p>(...);</span>
</span></span><span class=line><span class=cl>        <span class=n>options</span><span class=p>.</span><span class=n>UseTriggers</span><span class=p>(</span><span class=n>triggerOptions</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>triggerOptions</span><span class=p>.</span><span class=n>AddTrigger</span><span class=p>&lt;</span><span class=n>SetCreatedOnDate</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>            <span class=n>triggerOptions</span><span class=p>.</span><span class=n>AddTrigger</span><span class=p>&lt;</span><span class=n>CreateWelcomeEmail</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>            <span class=n>triggerOptions</span><span class=p>.</span><span class=n>AddTrigger</span><span class=p>&lt;</span><span class=n>SendEmail</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>services</span><span class=p>.</span><span class=n>AddSingleton</span><span class=p>&lt;</span><span class=n>IEmailSendService</span><span class=p>,</span> <span class=n>EmailSendService</span><span class=p>&gt;();</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>As triggers are managed and invoked by your DbContext, its completely database agnostic. As long as your manipulate your database through your DbContext and as long as you do not use raw queries and bulk operations, Triggers will be guaranteed to run for your changes.</p><h2 id=conclusion>Conclusion</h2><p>At this point I hope you have a basic understanding of how EntityFrameworkCore.Triggered can be beneficial in implementing business logic. The product has evolved over the last couple of years in a generic library used by quite a few projects and it&rsquo;s battle tested.</p><p>Subsequent articles in this series will dive deeper into advanced features, internal workings and perhaps most important: case studies.</p><div class=blog-tags><a href=https://www.onthedrift.com/tags/.net/>.NET</a>&nbsp;
<a href=https://www.onthedrift.com/tags/efcore/>EFCore</a>&nbsp;
<a href=https://www.onthedrift.com/tags/efcore.triggered/>EFCore.Triggered</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-triggered-part1%2f&text=Triggers%20for%20Entity%20Framework%20Core&via=onthedrift2" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-triggered-part1%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-triggered-part1%2f&title=Triggers%20for%20Entity%20Framework%20Core" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-triggered-part1%2f&title=Triggers%20for%20Entity%20Framework%20Core" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-triggered-part1%2f&title=Triggers%20for%20Entity%20Framework%20Core" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fwww.onthedrift.com%2fposts%2fefcore-triggered-part1%2f&description=Triggers%20for%20Entity%20Framework%20Core" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section><h4 class=see-also>See also</h4><ul><li><a href=/posts/efcore-projectables-perf/>EFCore.Projectables and the curious case of an unexpected performance boost</a></li><li><a href=/posts/efcore-projectables/>EF Projections on computed properties and methods without a hassle!</a></li><li><a href=/posts/scenario-tests/>Introducing ScenarioTests, an experiment in improving the .NET testing experience</a></li><li><a href=/posts/activator-utilities/>Activator utilities: activate anything!</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://www.onthedrift.com/posts/activator-utilities/ data-toggle=tooltip data-placement=top title="Activator utilities: activate anything!">&larr; Previous Post</a></li><li class=next><a href=https://www.onthedrift.com/posts/scenario-tests/ data-toggle=tooltip data-placement=top title="Introducing ScenarioTests, an experiment in improving the .NET testing experience">Next Post &rarr;</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:koen@linker.io title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/koenbeuk title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/onthedrift2 title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://stackoverflow.com/users/272424/polity title=StackOverflow><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a href title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=https://www.onthedrift.com>Koen</a>
&nbsp;&bull;&nbsp;&copy;
2023
&nbsp;&bull;&nbsp;
<a href=https://www.onthedrift.com>On The Drift</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.109.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>
&nbsp;&bull;&nbsp;[<a href=https://github.com/koenbeuk/onthedrift/tree/7f12904ba27428ccd95611a20e2fc56334d742a1>7f12904b</a>]</p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script>
<script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=https://www.onthedrift.com/js/main.js></script>
<script src=https://www.onthedrift.com/js/highlight.min.js></script>
<script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://www.onthedrift.com/js/load-photoswipe.js></script>
<script type=text/javascript>!function(e,t,n){var s,o=e.location,f="script",m="instrumentationKey",a="ingestionendpoint",d="disableExceptionTracking",l="ai.device.",c="toLowerCase",r="crossOrigin",u="POST",h="appInsightsSDK",i=n.name||"appInsights";(n.name||e[h])&&(e[h]=i),s=e[i]||function(s){var p,g,v,j,C,k=!1,b=!1,i={initialize:!0,queue:[],sv:"5",version:2,config:s};function y(e,t){var n={},s="Browser";return n[l+"id"]=s[c](),n[l+"type"]=s,n["ai.operation.name"]=o&&o.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(i.sv||i.version),{time:function(){var e=new Date;function t(e){var t=""+e;return 1===t.length&&(t="0"+t),t}return e.getUTCFullYear()+"-"+t(1+e.getUTCMonth())+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+((e.getUTCMilliseconds()/1e3).toFixed(3)+"").slice(2,5)+"Z"}(),iKey:e,name:"Microsoft.ApplicationInsights."+e.replace(/-/g,"")+"."+t,sampleRate:100,tags:n,data:{baseData:{ver:2}}}}if(g=s.url||n.src,g){function E(){var r,l,d,h,f,p,v,j,_,w,O;k=!0,i.queue=[],b||(b=!0,l=g,h=function(){var t,n,o,i,r,e={},l=s.connectionString;if(l)for(o=l.split(";"),t=0;t<o.length;t++)n=o[t].split("="),2===n.length&&(e[n[0][c]()]=n[1]);return e[a]||(i=e.endpointsuffix,r=i?e.location:null,e[a]="https://"+(r?r+".":"")+"dc."+(i||"services.visualstudio.com")),e}(),f=h[m]||s[m]||"",p=h[a],r=p?p+"/v2/track":s.endpointUrl,(v=[]).push((d="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",j=l,_=r,(O=(w=y(f,"Exception")).data).baseType="ExceptionData",O.baseData.exceptions=[{typeName:"SDKLoadFailed",message:d.replace(/\./g,"-"),hasFullStack:!1,stack:d+`
Snippet failed to load [`+j+`] -- Telemetry is disabled
Help Link: https://go.microsoft.com/fwlink/?linkid=2128109
Host: `+(o&&o.pathname||"_unknown_")+`
Endpoint: `+_,parsedStack:[]}],w)),v.push(function(e,t,n,s){var o,i=y(f,"Message"),a=i.data;return a.baseType="MessageData",o=a.baseData,o.message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+n+")").replace(/"/g,"")+'"',o.properties={endpoint:s},i}(0,0,l,r)),function(t,s){if(JSON){var o,i=e.fetch;i&&!n.useXhr?i(s,{method:u,body:JSON.stringify(t),mode:"cors"}):XMLHttpRequest&&(o=new XMLHttpRequest,o.open(u,s),o.setRequestHeader("Content-type","application/json"),o.send(JSON.stringify(t)))}}(v,r))}function w(e,t){b||setTimeout(function(){!t&&i.core||E()},500)}v=function(){var s,e=t.createElement(f);return e.src=g,s=n[r],!s&&""!==s||"undefined"==e[r]||(e[r]=s),e.onload=w,e.onerror=E,e.onreadystatechange=function(t,n){"loaded"!==e.readyState&&"complete"!==e.readyState||w(0,n)},e}(),n.ld<0?t.getElementsByTagName("head")[0].appendChild(v):setTimeout(function(){t.getElementsByTagName(f)[0].parentNode.appendChild(v)},n.ld||0)}try{i.cookie=t.cookie}catch{}function _(e){for(;e.length;)!function(e){i[e]=function(){var t=arguments;k||i.queue.push(function(){i[e].apply(i,t)})}}(e.pop())}var h="track",O="TrackPage",x="TrackEvent";return _([h+"Event",h+"PageView",h+"Exception",h+"Trace",h+"DependencyData",h+"Metric",h+"PageViewPerformance","start"+O,"stop"+O,"start"+x,"stop"+x,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),i.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4},C=(s.extensionConfig||{}).ApplicationInsightsAnalytics||{},!0!==s[d]&&!0!==C[d]&&(p="onerror",_(["_"+p]),j=e[p],e[p]=function(e,t,n,s,o){var a=j&&j(e,t,n,s,o);return!0!==a&&i["_"+p]({message:e,url:t,lineNumber:n,columnNumber:s,error:o}),a},s.autoExceptionInstrumented=!0),i}(n.cfg);function p(){n.onInit&&n.onInit(s)}(e[i]=s).queue&&0===s.queue.length?(s.queue.push(p),s.trackPageView({})):p()}(window,document,{src:"https://js.monitor.azure.com/scripts/b/ai.2.min.js",crossOrigin:"anonymous",cfg:{connectionString:"InstrumentationKey=cfd015d4-8126-4254-bc26-a6a73ad5d6d0;IngestionEndpoint=https://westus2-0.in.applicationinsights.azure.com/"}})</script></body></html>